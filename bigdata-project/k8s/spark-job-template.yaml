apiVersion: batch/v1
kind: Job
metadata:
  name: spark-job-DATEPLACEHOLDER # Sẽ được replace bởi Airflow
  labels:
    app: spark-job
    date: DATEPLACEHOLDER
spec:
  backoffLimit: 2 # Retry tối đa 2 lần nếu fail
  ttlSecondsAfterFinished: 86400 # Xóa job sau 24h
  template:
    metadata:
      labels:
        app: spark-job
    spec:
      restartPolicy: Never
      containers:
        - name: spark-submit
          image: phantaii/spark-job:latest # Thay bằng image registry của bạn
          imagePullPolicy: Always
          command:
            - /opt/spark/bin/spark-submit
            - --master
            - spark://spark-master.default.svc.cluster.local:7077
            - --deploy-mode
            - client
            - --conf
            - spark.driver.memory=512m
            - --conf
            - spark.executor.memory=512m
            - --conf
            - spark.executor.cores=1
            - --conf
            - spark.executor.instances=2
            - --conf
            - spark.hadoop.fs.s3a.endpoint=http://minio.default.svc.cluster.local:9000
            - --conf
            - spark.hadoop.fs.s3a.access.key=minioadmin
            - --conf
            - spark.hadoop.fs.s3a.secret.key=minioadmin
            - --conf
            - spark.hadoop.fs.s3a.path.style.access=true
            - --conf
            - spark.hadoop.fs.s3a.impl=org.apache.hadoop.fs.s3a.S3AFileSystem
            - --conf
            - spark.cassandra.connection.host=cassandra.default.svc.cluster.local
            - --conf
            - spark.cassandra.connection.port=9042
            - --jars
            - /opt/spark/jars-extra/aws-java-sdk-bundle-1.12.367.jar,/opt/spark/jars-extra/hadoop-aws-3.3.4.jar,/opt/spark/jars-extra/spark-cassandra-connector-assembly_2.12-3.4.1.jar
            - /opt/spark/jobs/spark_job.py
            - --date
            - DATEPLACEHOLDER # Sẽ được replace bởi Airflow (format: YYYY-MM-DD)
          env:
            - name: SPARK_USER
              value: "spark"
          resources:
            requests:
              memory: "512Mi"
              cpu: "500m"
            limits:
              memory: "1Gi"
              cpu: "1000m"
